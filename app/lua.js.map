{
  "version": 3,
  "file": "lua.js",
  "sources": [
    "/app/lua.tsx"
  ],
  "sourcesContent": [
    "import { JSX, useEffect, useRef, useState } from \"react\";\nimport { makeInit } from \"./lib/init\";\nimport { LuaEngine, LuaFactory } from \"wasmoon\";\nimport React from \"react\";\nimport { sleep } from \"./lib/userscript\";\n\nconst factory = new LuaFactory();\nconst lua = await factory.createEngine();\n\n// wasmoon wants to have a lua thing\n// window.setImmediate = (fn) => setTimeout(fn, 0);\n\ninterface LuaOutput {\n\ttext: string | JSX.Element | JSX.Element[];\n\twhat: \"input\" | \"output\" | \"error\" | \"print\";\n}\n\nfunction App() {\n\tconst [luaOutput, setLuaOutput] = useState<LuaOutput[]>([\n\t\t{\n\t\t\ttext: <span>This is a Lua REPL. Type Lua code in the box below and press \"Run\".</span>,\n\t\t\twhat: \"print\",\n\t\t},\n\t]);\n\tconst [luaInput, setLuaInput] = useState(\"\");\n\n\tconst [lua, setLua] = useState<LuaEngine | null>(null);\n\n\tfunction formatLuaValue(lua, value: unknown): JSX.Element {\n\t\tconst inspect = lua.global.get(\"inspect\");\n\t\t// console.log(inspect);\n\t\tif (typeof value === \"string\") {\n\t\t\treturn <span className=\"string\">{value}</span>;\n\t\t} else if (typeof value === \"number\" || typeof value === \"boolean\" || value == null) {\n\t\t\treturn <span className=\"literal\">{JSON.stringify(value) ?? \"nil\"}</span>;\n\t\t} else {\n\t\t\ttry {\n\t\t\t\treturn <span>{inspect.inspect(value)}</span>;\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(e);\n\t\t\t\treturn <span>{String(value)}</span>;\n\t\t\t}\n\t\t}\n\t}\n\n\tuseEffect(() => {\n\t\tnew LuaFactory()\n\t\t\t.createEngine({\n\t\t\t\tenableProxy: false,\n\t\t\t})\n\t\t\t.then(async (lua) => {\n\t\t\t\twindow.lua = lua;\n\n\t\t\t\tlua.global.set(\"print\", (...args: unknown[]) => {\n\t\t\t\t\tconsole.log(\"Lua:\", ...args);\n\t\t\t\t\tsetLuaOutput((luaOutput) => [\n\t\t\t\t\t\t...luaOutput,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttext: args.map((arg, i) => <React.Fragment key={i}>{formatLuaValue(lua, arg)} </React.Fragment>),\n\t\t\t\t\t\t\twhat: \"print\",\n\t\t\t\t\t\t},\n\t\t\t\t\t]);\n\t\t\t\t});\n\n\t\t\t\t// go nuts\n\t\t\t\tlua.global.set(\"JSON\", JSON);\n\n\t\t\t\tconst methodProxy = (target) =>\n\t\t\t\t\tnew Proxy(target, {\n\t\t\t\t\t\tget: (target, prop) => {\n\t\t\t\t\t\t\tif (typeof target[prop] === \"function\") {\n\t\t\t\t\t\t\t\treturn target[prop].bind(target);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\treturn target[prop];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\n\t\t\t\t// function autoAwait(name, fn) {\n\t\t\t\t// \tlua.global.set(name, fn);\n\t\t\t\t// \tlua.doString(`do\n\t\t\t\t//             local fn = ${name}\n\t\t\t\t//             ${name} = nil\n\t\t\t\t//             function ${name}(...)\n\t\t\t\t//             return fn(...):await()\n\t\t\t\t//             end\n\t\t\t\t//             end`);\n\t\t\t\t// }\n\t\t\t\t// autoAwait(\"fetch\", (...args) => fetch(...args).then(methodProxy));\n\n\t\t\t\tlua.global.set(\"_fetchModuleCode\", async (module: string) => {\n\t\t\t\t\treturn await fetch(`/app/lua/${module}.lua`).then((r) => {\n\t\t\t\t\t\tif (!r.ok) {\n\t\t\t\t\t\t\tthrow new Error(`Failed to fetch module ${module}`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn r.text();\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t\tawait lua.doString(`do\n                    local fetchModuleCode = _fetchModuleCode\n                    _fetchModuleCode = nil\n                    require = function(module)\n                        local code = fetchModuleCode(module):await()\n                        return load(code)()\n                    end\n                end`);\n\n\t\t\t\tsetLua(lua);\n\n\t\t\t\tlua.doString(`\n                    inspect = require('inspect')\n                    _ = require('pipeline')\n                `);\n\t\t\t});\n\t}, []);\n\n\tconst containerRef = useRef<HTMLDivElement>(null);\n\tconst inputRef = useRef<HTMLInputElement>(null);\n\tuseEffect(() => {\n\t\tinputRef.current?.focus();\n\t}, []);\n\n\tconst [inputHistoryIndex, setInputHistoryIndex] = useState(-1);\n\n\treturn (\n\t\t<div>\n\t\t\t<div ref={containerRef} className=\"output-container hljs\">\n\t\t\t\t{luaOutput.map(({ text, what }, idx) => (\n\t\t\t\t\t<div key={idx} className={`${what} block`}>\n\t\t\t\t\t\t{text}\n\t\t\t\t\t</div>\n\t\t\t\t))}\n\t\t\t</div>\n\t\t\t<form\n\t\t\t\tonSubmit={async (e) => {\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tsetLuaOutput((luaOutput) => [...luaOutput, { text: luaInput, what: \"input\" }]);\n\t\t\t\t\ttry {\n\t\t\t\t\t\tlet output;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\toutput = await lua!.doString(\"return \" + luaInput);\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\toutput = await lua!.doString(luaInput);\n\t\t\t\t\t\t}\n\t\t\t\t\t\toutput = formatLuaValue(lua, output);\n\t\t\t\t\t\tsetLuaOutput((luaOutput) => [...luaOutput, { text: output, what: \"output\" }]);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tsetLuaOutput((luaOutput) => [...luaOutput, { text: e.message, what: \"error\" }]);\n\t\t\t\t\t}\n\t\t\t\t\tsetLuaInput(\"\");\n\t\t\t\t\tsetInputHistoryIndex(-1);\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tif (containerRef.current) {\n\t\t\t\t\t\t\tcontainerRef.current.scrollTop = containerRef.current.scrollHeight;\n\t\t\t\t\t\t}\n\t\t\t\t\t}, 0);\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<input\n\t\t\t\t\tref={inputRef}\n\t\t\t\t\tvalue={luaInput}\n\t\t\t\t\tonChange={(e) => setLuaInput(e.target.value)}\n\t\t\t\t\tonKeyDown={(e) => {\n\t\t\t\t\t\tif (e.key === \"ArrowUp\" || e.key === \"ArrowDown\") {\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\tconst direction = e.key === \"ArrowUp\" ? -1 : 1;\n\t\t\t\t\t\t\tconst idx = inputHistoryIndex + direction;\n\t\t\t\t\t\t\tsetInputHistoryIndex(idx);\n\t\t\t\t\t\t\tconst inputHistory = [...luaOutput.filter((o) => o.what === \"input\").map((o) => o.text), \"\"];\n\t\t\t\t\t\t\tconst entry = inputHistory.at(idx % inputHistory.length);\n\t\t\t\t\t\t\tsetLuaInput(entry ?? \"\");\n\t\t\t\t\t\t}\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t\t<button type=\"submit\">Run</button>\n\t\t\t</form>\n\t\t</div>\n\t);\n}\n\nexport default makeInit(App);\n"
  ],
  "names": [
    "LuaFactory",
    "useState",
    "jsx",
    "lua",
    "useEffect",
    "luaOutput",
    "jsxs",
    "useRef",
    "e"
  ],
  "mappings": "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"
}